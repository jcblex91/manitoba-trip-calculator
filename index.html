<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shibu's App</title>
    <!-- Load Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the Google Autocomplete dropdown */
        .pac-container {
            /* Ensure the Google Autocomplete dropdown is visible above everything */
            z-index: 10000;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Styling for the loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Styling for the custom toggle switch */
        #round-trip-toggle:checked ~ .block {
            background-color: #3b82ff; /* Blue for ON */
        }
        #round-trip-toggle:checked ~ .dot {
            transform: translateX(100%);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex items-start md:items-center justify-center font-sans">

    <div class="w-full max-w-lg bg-white p-6 md:p-8 rounded-xl shadow-2xl space-y-6 mb-8">
        <h1 class="text-3xl font-extrabold text-gray-800 text-center border-b pb-3 mb-4">
            Itinerary and Trip Cost Planner
        </h1>

        <!-- Input Section -->
        <div id="input-section" class="space-y-6">
            <!-- 1. Origin -->
            <div class="space-y-1">
                <span class="text-sm font-medium text-gray-700">1. Start Location (Origin)</span>
                <div class="flex space-x-2">
                    <input id="origin-input" type="text" placeholder="Starting point in Manitoba"
                           class="location-input flex-grow block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"
                           required>
                    <button id="current-location-button" type="button"
                            class="bg-blue-500 text-white p-2 rounded-lg font-semibold hover:bg-blue-600 transition duration-150 flex items-center justify-center text-sm whitespace-nowrap">
                        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.243-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        Current
                    </button>
                </div>
            </div>

            <!-- 2. Pickup Locations -->
            <div class="space-y-3 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                <h2 class="text-lg font-bold text-yellow-800">Pickup Locations (Drag to reorder)</h2>
                <div id="pickup-container" class="space-y-4">
                    <!-- Pickups will be added here dynamically -->
                </div>
                <button id="add-pickup-button" type="button"
                        class="w-full text-yellow-600 border border-yellow-600 py-2 rounded-lg font-semibold hover:bg-yellow-100 transition duration-150">
                    + Add Pickup Stop
                </button>
            </div>
            
            <!-- 3. Drop-off Locations -->
            <div class="space-y-3 p-4 bg-green-50 rounded-lg border border-green-200">
                <h2 class="text-lg font-bold text-green-800">Drop-off Locations (Drag to reorder)</h2>
                <div id="dropoff-container" class="space-y-4">
                    <!-- Drop-offs will be added here dynamically (Default added in JS) -->
                </div>
                <button id="add-dropoff-button" type="button"
                        class="w-full text-green-600 border border-green-600 py-2 rounded-lg font-semibold hover:bg-green-100 transition duration-150">
                    + Add Drop-off Stop
                </button>
            </div>

            <!-- Round Trip Toggle -->
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg shadow-inner">
                <span class="text-base font-semibold text-gray-700">Calculate Round Trip (Return to Start)?</span>
                <label for="round-trip-toggle" class="flex items-center cursor-pointer">
                    <div class="relative">
                        <input id="round-trip-toggle" type="checkbox" class="sr-only" checked>
                        <div class="block bg-gray-300 w-14 h-8 rounded-full transition duration-300"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition duration-300 shadow-md"></div>
                    </div>
                </label>
            </div>

            <!-- Fuel Inputs -->
            <div class="grid grid-cols-2 gap-4 mt-6 border-t pt-4 border-gray-200">
                <label class="block">
                    <!-- UPDATED: Use smaller text size on mobile to prevent label wrapping -->
                    <span class="text-xs sm:text-sm font-medium text-gray-700">Fuel Efficiency (km/L or mi/gal)</span>
                    <input id="fuel-efficiency-input" type="number" min="1" placeholder="e.g., 10" value="10"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"
                           required>
                </label>

                <label class="block">
                    <!-- UPDATED: Use smaller text size on mobile to prevent label wrapping -->
                    <span class="text-xs sm:text-sm font-medium text-gray-700">Fuel Price (per L or gal)</span>
                    <input id="fuel-price-input" type="number" min="0.01" step="0.01" placeholder="e.g., 1.50" value="1.50"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"
                           required>
                </label>
            </div>

            <button id="calculate-button"
                    class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold text-lg hover:bg-blue-700 transition duration-150 shadow-md">
                Calculate Total Trip Cost
            </button>
        </div>

        <!-- Result Section -->
        <div id="result-section" class="hidden mt-6 pt-4 border-t border-gray-200">
            <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Trip Summary</h2>
            <div id="loading-indicator" class="flex justify-center items-center space-x-2 hidden">
                <div class="spinner"></div>
                <p class="text-blue-600">Calculating route and distance...</p>
            </div>

            <div id="summary-content" class="space-y-3">
                <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg shadow-sm">
                    <span class="font-semibold text-gray-600">Total Distance:</span>
                    <span id="display-distance" class="font-bold text-blue-600">--</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg shadow-sm">
                    <span class="font-semibold text-gray-600">Estimated Travel Time:</span>
                    <span id="display-duration" class="font-bold text-blue-600">--</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg shadow-sm">
                    <span class="font-semibold text-gray-600">Estimated Fuel Cost:</span>
                    <span id="display-cost" class="font-bold text-green-600 text-xl">--</span>
                </div>
            </div>

             <!-- Error/Message Box -->
            <div id="message-box" class="mt-4 p-3 bg-red-100 text-red-700 rounded-lg hidden" role="alert">
                An error occurred. Please check your locations and API key usage.
            </div>
        </div>
    </div>

    <!-- Google Maps API Script -->
    <script>
        // !! IMPORTANT: REPLACE WITH YOUR ACTUAL API KEY !!
        const API_KEY = "YOUR_API_KEY_HERE";

        const calculateButton = document.getElementById('calculate-button');
        const addPickupButton = document.getElementById('add-pickup-button');
        const addDropoffButton = document.getElementById('add-dropoff-button');
        const currentLocationButton = document.getElementById('current-location-button');
        const roundTripToggle = document.getElementById('round-trip-toggle'); 
        
        const originInput = document.getElementById('origin-input');
        const pickupContainer = document.getElementById('pickup-container');
        const dropoffContainer = document.getElementById('dropoff-container');

        const fuelEfficiencyInput = document.getElementById('fuel-efficiency-input');
        const fuelPriceInput = document.getElementById('fuel-price-input');

        const resultSection = document.getElementById('result-section');
        const loadingIndicator = document.getElementById('loading-indicator');
        const summaryContent = document.getElementById('summary-content');
        const displayDistance = document.getElementById('display-distance');
        const displayDuration = document.getElementById('display-duration');
        const displayCost = document.getElementById('display-cost');
        const messageBox = document.getElementById('message-box');

        let directionsService;
        let geocoder; 
        let uniqueIdCounter = 0; 
        
        // --- Manitoba Restriction Constants (NEW) ---
        // Define approximate bounding box for Manitoba for search biasing
        const MANITOBA_NE = { lat: 60.0, lng: -88.0 }; // Northeast corner approximation
        const MANITOBA_SW = { lat: 49.0, lng: -102.0 }; // Southwest corner approximation
        const CANADA_RESTRICTION = { country: 'ca' };
        // --- End Restriction Constants ---


        // --- Drag and Drop State and Handlers ---
        let dragSrcEl = null;

        function handleDragStart(e) {
            this.style.opacity = '0.4'; // Visual feedback for dragging
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            // Set data to identify the element type (pickup/dropoff)
            e.dataTransfer.setData('text/plain', this.getAttribute('data-stop-type')); 
        }

        function handleDragEnd(e) {
            this.style.opacity = '1';
            // Clear all visual drag over effects
            document.querySelectorAll('.stop-group').forEach(item => {
                item.classList.remove('border-blue-400', 'border-2', 'border-dashed');
            });
        }

        function handleDragOver(e) {
            e.preventDefault(); // Necessary to allow dropping
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            // Check if the source and target types match
            const sourceType = dragSrcEl.getAttribute('data-stop-type');
            const targetType = this.getAttribute('data-stop-type');

            if (dragSrcEl !== this && sourceType === targetType) {
                 this.classList.add('border-blue-400', 'border-2', 'border-dashed');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('border-blue-400', 'border-2', 'border-dashed');
        }

        function handleDrop(e) {
            e.stopPropagation();
            
            this.classList.remove('border-blue-400', 'border-2', 'border-dashed');

            if (dragSrcEl !== this) {
                const sourceType = dragSrcEl.getAttribute('data-stop-type');
                const targetType = this.getAttribute('data-stop-type');

                // Only allow dropping within the same container type
                if (sourceType === targetType) {
                    const targetContainer = this.parentNode;
                    
                    // Insert the dragged element before the element being dragged over
                    targetContainer.insertBefore(dragSrcEl, this);
                    
                    // Re-label the stops to update numbers
                    relabelStops();
                } else {
                    displayMessage(`Cannot move a ${sourceType} stop into the ${targetType} section.`, 'error');
                }
            }
            return false;
        }

        function setupDragAndDrop(element) {
            element.addEventListener('dragstart', handleDragStart);
            element.addEventListener('dragenter', handleDragEnter);
            element.addEventListener('dragover', handleDragOver);
            element.addEventListener('dragleave', handleDragLeave);
            element.addEventListener('drop', handleDrop);
            element.addEventListener('dragend', handleDragEnd);
        }
        // --- End Drag and Drop ---


        /**
         * Clears and displays a temporary message in the message box.
         * @param {string} text The message to display.
         * @param {string} type 'error' (red) or 'info' (blue).
         */
        function displayMessage(text, type = 'error') {
            messageBox.textContent = text;
            messageBox.className = 'mt-4 p-3 rounded-lg hidden';
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'info') {
                messageBox.classList.add('bg-blue-100', 'text-blue-700');
            }
            messageBox.classList.remove('hidden');

            // Optionally hide after a few seconds if it's an info message
            if (type === 'info') {
                 setTimeout(() => messageBox.classList.add('hidden'), 3000);
            }
        }

        /**
         * Initializes Google Maps Autocomplete for a specific input field,
         * restricting results to Canada and biasing towards Manitoba.
         */
        function initializeAutocompleteForInput(inputElement) {
            if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                 return;
            }

            // Create LatLngBounds for Manitoba biasing
            const manitobaBounds = new google.maps.LatLngBounds(MANITOBA_SW, MANITOBA_NE);

            const autocompleteOptions = {
                fields: ["formatted_address", "geometry", "name"],
                strictBounds: false, // Use biasing, not strict restriction
                types: ["geocode", "establishment"],
                // Restrict results to Canada
                componentRestrictions: CANADA_RESTRICTION,
                // Bias results toward Manitoba
                bounds: manitobaBounds, 
            };

            const autocomplete = new google.maps.places.Autocomplete(inputElement, autocompleteOptions);
        }

        /**
         * Master function to initialize Google services.
         */
        function initAutocomplete() {
            if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                 displayMessage("Google Maps API failed to load. Please check your API key.", 'error');
                 return;
            }

            directionsService = new google.maps.DirectionsService();
            geocoder = new google.maps.Geocoder(); 
            
            initializeAutocompleteForInput(originInput);
            
            document.querySelectorAll('.pickup-input, .dropoff-input').forEach(initializeAutocompleteForInput);
            
            // Add default stops on load
            if (pickupContainer.children.length === 0) {
                 addPickup();
            }
            
            if (dropoffContainer.children.length === 0) {
                 addDropoff();
            }
            
            displayMessage("Google Maps services loaded and restricted to Manitoba, Canada.", 'info');
        }
        
        /**
         * Uses the Geolocation API to find and set the user's current location.
         */
        function setCurrentLocation() {
            if (typeof google === 'undefined' || typeof google.maps === 'undefined' || !geocoder) {
                displayMessage("Google Maps services are still loading. Please wait a moment and try again.", 'error');
                return;
            }
            
            if (!navigator.geolocation) {
                displayMessage("Geolocation is not supported by your browser.", 'error');
                return;
            }

            // Temporarily disable button and show a loading state
            currentLocationButton.disabled = true;
            const originalText = currentLocationButton.innerHTML;
            currentLocationButton.innerHTML = `<div class="spinner w-4 h-4 mr-2"></div> Finding...`;

            navigator.geolocation.getCurrentPosition((position) => {
                const latlng = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                };

                // Use Geocoder to turn coordinates into a human-readable address
                geocoder.geocode({ location: latlng }, (results, status) => {
                    currentLocationButton.disabled = false;
                    currentLocationButton.innerHTML = originalText;

                    if (status === 'OK' && results[0]) {
                        originInput.value = results[0].formatted_address;
                        displayMessage("Current location set!", 'info');
                    } else {
                        // Fallback to coordinates if geocoding fails
                        originInput.value = `${latlng.lat}, ${latlng.lng}`;
                        displayMessage("Failed to find exact address, using coordinates.", 'info');
                    }
                });
            }, (error) => {
                currentLocationButton.disabled = false;
                currentLocationButton.innerHTML = originalText;

                let errorMessage = "Geolocation failed: ";
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage += "You denied the request for Geolocation.";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage += "Location information is unavailable.";
                        break;
                    case error.TIMEOUT:
                        errorMessage += "The request to get user location timed out.";
                        break;
                    default:
                        errorMessage += "An unknown error occurred.";
                        break;
                }
                displayMessage(errorMessage, 'error');
            });
        }


        /**
         * Generic function to add a stop of a specific type.
         */
        function addStop(type, container, placeholder) {
            uniqueIdCounter++;
            const newStopId = `${type}-input-${uniqueIdCounter}`;
            
            const stopDiv = document.createElement('div');
            // ADDED drag-and-drop attributes and styling
            stopDiv.className = 'flex space-x-2 stop-group p-2 rounded-lg shadow-sm border border-gray-200 cursor-move bg-white';
            stopDiv.setAttribute('draggable', 'true');
            stopDiv.setAttribute('data-stop-type', type);


            stopDiv.innerHTML = `
                <!-- Drag Handle -->
                <div class="drag-handle text-gray-400 self-center hover:text-gray-600 transition duration-150 cursor-grab">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </div>
                <label class="block flex-grow">
                    <span class="text-sm font-medium text-gray-700 stop-label"></span>
                    <input id="${newStopId}" type="text" placeholder="${placeholder}"
                           class="${type}-input location-input block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </label>
                <button type="button" class="remove-stop-button self-end bg-red-500 text-white p-2 rounded-lg h-[40px] w-[40px] hover:bg-red-600 transition duration-150 flex items-center justify-center text-xl leading-none" aria-label="Remove Stop">
                    &times;
                </button>
            `;

            container.appendChild(stopDiv);
            initializeAutocompleteForInput(document.getElementById(newStopId));
            relabelStops();

            // Setup Drag and Drop events
            setupDragAndDrop(stopDiv);

            // Add event listener for the remove button
            stopDiv.querySelector('.remove-stop-button').addEventListener('click', () => {
                removeStop(stopDiv);
            });
        }

        function addPickup() {
            addStop('pickup', pickupContainer, 'Pickup location in Manitoba');
        }

        function addDropoff() {
            addStop('dropoff', dropoffContainer, 'Drop-off location in Manitoba');
        }

        /**
         * Removes a stop input field and re-labels the remaining ones.
         */
        function removeStop(stopDiv) {
            stopDiv.remove();
            relabelStops();
        }
        
        /**
         * Re-labels all dynamic stops based on their container and position.
         */
        function relabelStops() {
            // Label Pickups
            const pickupGroups = pickupContainer.querySelectorAll('.stop-group');
            pickupGroups.forEach((group, index) => {
                const labelSpan = group.querySelector('.stop-label');
                if (labelSpan) {
                    labelSpan.textContent = `Pickup ${index + 1}`;
                }
            });

            // Label Drop-offs
            const dropoffGroups = dropoffContainer.querySelectorAll('.stop-group');
            const totalDropoffs = dropoffGroups.length;

            dropoffGroups.forEach((group, index) => {
                const labelSpan = group.querySelector('.stop-label');
                if (labelSpan) {
                    const isFinal = (index === totalDropoffs - 1);
                    labelSpan.textContent = `Drop-off ${index + 1} ${isFinal ? '(Final Destination)' : ''}`;
                }
            });
        }


        /**
         * Calculates the return trip from the final destination back to the origin.
         * @param {string} origin The starting point of the whole trip.
         * @param {string} destination The final drop-off point (start of the return leg).
         * @param {number} currentDistance The distance accumulated in the primary leg (in meters).
         * @param {number} currentDuration The duration accumulated in the primary leg (in seconds).
         */
        function calculateReturnTrip(origin, destination, currentDistance, currentDuration) {
            const returnRequest = {
                origin: destination,
                destination: origin,
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC,
            };

            directionsService.route(returnRequest, (response, status) => {
                const fuelEfficiency = parseFloat(fuelEfficiencyInput.value);
                const fuelPrice = parseFloat(fuelPriceInput.value);

                if (status !== 'OK') {
                    loadingIndicator.classList.add('hidden');
                    displayMessage(`Warning: Primary route calculated, but failed to calculate the return trip. Status: ${status}. Showing one-way result.`, 'error');
                    // Finalize with the one-way result anyway
                    finalizeTripCalculation(currentDistance, currentDuration, fuelEfficiency, fuelPrice);
                    return;
                }

                const returnLegDistance = response.routes[0].legs[0].distance.value;
                const returnLegDuration = response.routes[0].legs[0].duration.value;

                const finalDistance = currentDistance + returnLegDistance;
                const finalDuration = currentDuration + returnLegDuration;

                finalizeTripCalculation(finalDistance, finalDuration, fuelEfficiency, fuelPrice);
            });
        }

        /**
         * Finalizes the display of the trip calculation results.
         */
        function finalizeTripCalculation(totalDistanceMeters, totalDurationSeconds, fuelEfficiency, fuelPrice) {
            loadingIndicator.classList.add('hidden');

            // Format distance and time for display
            const distanceKm = totalDistanceMeters / 1000;
            const formattedDistance = (distanceKm).toFixed(1) + ' km';
            const formattedDuration = formatDuration(totalDurationSeconds);

            // Cost Calculation
            const fuelConsumedLiters = distanceKm / fuelEfficiency;
            const totalCost = fuelConsumedLiters * fuelPrice;

            // 6. Update the UI
            displayDistance.textContent = formattedDistance;
            displayDuration.textContent = formattedDuration;
            displayCost.textContent = `$${totalCost.toFixed(2)}`;

            // Show results
            summaryContent.classList.remove('hidden');
            resultSection.classList.remove('hidden');
        }


        /**
         * Fetches the route details using Google Maps DirectionsService and calculates the final cost.
         */
        function calculateTripCost() {
            if (typeof google === 'undefined' || typeof google.maps === 'undefined' || !directionsService) {
                displayMessage("Google Maps services are still loading or failed to initialize. Please wait and try again.", 'error');
                return;
            }

            displayMessage('', 'info'); // Clear messages
            resultSection.classList.add('hidden');
            summaryContent.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');

            const origin = originInput.value.trim();
            const fuelEfficiency = parseFloat(fuelEfficiencyInput.value);
            const fuelPrice = parseFloat(fuelPriceInput.value);

            // 1. Collect all Pickup and Drop-off values
            const pickupInputs = Array.from(document.querySelectorAll('.pickup-input')).map(input => input.value.trim()).filter(val => val);
            const dropoffInputs = Array.from(document.querySelectorAll('.dropoff-input')).map(input => input.value.trim()).filter(val => val);

            // Basic validation: must have origin and at least one dropoff
            if (!origin || dropoffInputs.length === 0 || isNaN(fuelEfficiency) || isNaN(fuelPrice) || fuelEfficiency <= 0 || fuelPrice <= 0) {
                displayMessage("Please ensure Start Location, at least one Drop-off, and valid Fuel inputs are provided.", 'error');
                loadingIndicator.classList.add('hidden');
                resultSection.classList.remove('hidden');
                return;
            }

            // 2. Determine Destination and Waypoints
            const destination = dropoffInputs[dropoffInputs.length - 1]; // Last drop-off is the final destination
            
            // Intermediate waypoints: all pickups + all drop-offs EXCEPT the last one
            const intermediateDropoffs = dropoffInputs.slice(0, -1);
            
            // The route order must be Origin -> Pickups -> Intermediate Dropoffs -> Final Dropoff
            const allIntermediateStops = [...pickupInputs, ...intermediateDropoffs];

            const waypoints = allIntermediateStops.map(location => ({ 
                location: location,
                stopover: true
            }));


            // 3. Construct the Directions API request for the primary leg
            const request = {
                origin: origin,
                destination: destination,
                waypoints: waypoints,
                optimizeWaypoints: false, 
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC,
            };

            // 4. Call the Directions Service for the primary leg
            directionsService.route(request, (response, status) => {

                if (status !== 'OK') {
                    loadingIndicator.classList.add('hidden');
                    let errorMessage = "Could not calculate the route. Status: " + status;
                    if (status === 'ZERO_RESULTS') {
                        errorMessage = "No route found. Please check all locations are valid and accessible.";
                    } else if (status === 'NOT_FOUND') {
                        errorMessage = "One or more locations could not be found. Check spelling and refine addresses.";
                    } else if (status === 'OVER_QUERY_LIMIT') {
                        errorMessage = "API Query Limit exceeded. Please check your Google Maps billing and usage.";
                    }
                    displayMessage(errorMessage, 'error');
                    resultSection.classList.remove('hidden');
                    return;
                }

                // 5. Calculate Total Distance and Duration for the PRIMARY LEG
                let totalDistanceMeters = 0;
                let totalDurationSeconds = 0;

                response.routes[0].legs.forEach(leg => {
                    totalDistanceMeters += leg.distance.value;
                    totalDurationSeconds += leg.duration.value;
                });

                const isRoundTrip = roundTripToggle.checked;
                const finalDestination = destination;
                const startOrigin = origin;

                if (isRoundTrip) {
                    // If round trip is requested, calculate the return leg
                    calculateReturnTrip(startOrigin, finalDestination, totalDistanceMeters, totalDurationSeconds);
                } else {
                    // If not round trip, finalize calculation immediately
                    finalizeTripCalculation(totalDistanceMeters, totalDurationSeconds, fuelEfficiency, fuelPrice);
                }
            });
        }

        /**
         * Helper function to format duration from seconds to human-readable string.
         */
        function formatDuration(seconds) {
            const days = Math.floor(seconds / (3600 * 24));
            seconds -= days * 3600 * 24;
            const hours = Math.floor(seconds / 3600);
            seconds -= hours * 3600;
            const minutes = Math.floor(seconds / 60);

            let parts = [];
            if (days > 0) parts.push(days + ' day' + (days > 1 ? 's' : ''));
            if (hours > 0) parts.push(hours + ' hr');
            if (minutes > 0) parts.push(minutes + ' min');

            return parts.length > 0 ? parts.join(' ') : 'Less than a minute';
        }

        // Event listeners
        addPickupButton.addEventListener('click', addPickup);
        addDropoffButton.addEventListener('click', addDropoff);
        calculateButton.addEventListener('click', calculateTripCost);
        currentLocationButton.addEventListener('click', setCurrentLocation); 

        // Load Google Maps API script dynamically
        function loadMapsScript() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${'AIzaSyC4ZlZggqxf0zRZRrBD3A4h_GWidIuc8c8'}&libraries=places,geometry&callback=initAutocomplete`;
            script.async = true;
            script.onerror = () => {
                displayMessage("Error loading the Google Maps API script. Check your API key or network connection.", 'error');
            };
            document.head.appendChild(script);
        }

        // Start loading the script when the window loads
        window.onload = loadMapsScript;

    </script>
</body>
</html>